---
title: "Stock Market Returns Distributions"
subtitle : 
author   : Giovanni Fossati
job      : null
output   : 
  html_document:
    self_contained: false
    css: css/gf_new.css
    theme: cerulean
    highlight: tango
    keep_md: no
    mathjax: default
    toc: no
    includes:
      md_extensions: +fenced_code_attributes
---

```{r setup, cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE, tidy = FALSE}
require("knitr")
options(width = 100, 
        scipen = 5)
opts_chunk$set(message = FALSE, 
               error = FALSE, 
               warning = FALSE, 
               collapse = TRUE, 
               tidy = FALSE,
               cache = FALSE, 
               cache.path = '.cache/', 
               comment = '#',
               fig.align = 'center', 
               dpi = 100, 
               dev = "png",
               fig.path = 'figures/')
# library("pkgmaker")
# knit_hooks$set(toggle = hook_toggle())
```

## PRELIMINARIES

Libraries needed for data processing and plotting:

```{r load_packages, cache = FALSE, echo = TRUE, message = FALSE, warning = FALSE, tidy = FALSE}
# library("lubridate")
# library("plyr")
library("ggplot2")
library("gridExtra")
```


## Introduction

Two interesting, blog posts:

* [The Generalized Lambda Distribution and GLDEX Package: Fitting Financial Return Data](http://www.r-bloggers.com/the-generalized-lambda-distribution-and-gldex-package-fitting-financial-return-data/)
* [The Generalized Lambda Distribution and GLDEX Package for Fitting Financial Return Data â€“ Part 2](http://www.r-bloggers.com/the-generalized-lambda-distribution-and-gldex-package-for-fitting-financial-return-data-part-2/)

The GLDEX package is available on [CRAN](http://cran.r-project.org/web/packages/GLDEX/index.html)


<a name="THE_DATA"></a>

## Libraries and Other Setup

```{r load-libraries, echo = TRUE, cache = TRUE}
library("quantmod")
library("GLDEX")
library("MASS")
```

```{r load-more_libraries_for_plotting, echo = TRUE}
library("scales")
source("./my_functions.R")
```

```{r set_dates}
start.date <- "1986-01-01"
end.date <- "2014-12-31"

xxlin <- seq(-25.0, 25.0, by = 0.1)
xxlog <- seq(-2.0, 2.0, by = 0.001)
```

<hr class="thin_separator">

# Three Broad Market Indices


## Wilshire 5000

Fetch the data with `quantmod`:

```{r wilshire5000-load, cache = TRUE}
# getSymbols("VTSMX", from = "1994-01-01")
getSymbols("VTSMX", from = start.date, to = end.date)
VTSMX.vec <- as.vector(VTSMX[, 4])
```

Prepare returns:

```{r wilshire5000-prepare_data, cache = TRUE}
WW <- prepare_data(data = VTSMX.vec, xlin = xxlin, xlog = xxlog)
```


```{r wilshire5000-returns, cache = TRUE}
Wilsh5000rlog <- diff(log(VTSMX.vec), lag = 1)
Wilsh5000r <- 100.0*(exp(Wilsh5000rlog) - 1)
```

Fit with Generalized Lambda Distribution:

```{r wilshire5000-fit_gld, cache = TRUE}
W5000r.fit <- fun.RMFMKL.ml(Wilsh5000r)
W5000r.y.gl <- dgl(xxlin, W5000r.fit)

nfit1 <- fitdistr(Wilsh5000r[abs(Wilsh5000r) <= 2.0], "normal")
nfit2 <- fitdistr(Wilsh5000r[abs(Wilsh5000r) <= 1.5], "normal")
W5000r.y.n1 <- dnorm(xxlin, mean = nfit1$estimate[1], sd = nfit1$estimate[2])
W5000r.y.n2 <- dnorm(xxlin, mean = nfit2$estimate[1], sd = nfit2$estimate[2])
```

```{r wilshire5000-prepare_df}
# W5000_data.df <- data.frame(returns = Wilsh5000r, stringsAsFactors = FALSE)
W5000_fits.df <- data.frame(x = xxlin, ygl = W5000r.y.gl, yn = W5000r.y.n1)
```

Plot distributions:

```{r wilshire5000-plot_distributions, cache = TRUE, eval = FALSE}
hist(Wilsh5000r, breaks = seq(-55.0, 55.0, by = 0.10), xlim = c(-8.0, 8.0), freq = FALSE,
     xlab = "daily returns (%)",
     main = "Wilshire 5000")
lines(xxlin, W5000r.y.n1, col = "green2", lwd = 2)
lines(xxlin, W5000r.y.n2, col = "blue2", lwd = 2)
lines(xxlin, W5000r.y.gl, col = "red2", lwd = 2)
```

```{r wilshire5000-plot_distributions_NEW, cache = TRUE, eval = FALSE}
hist(WW$rr_rel, breaks = seq(-55.0, 55.0, by = 0.10), xlim = c(-8.0, 8.0), freq = FALSE,
     xlab = "daily returns (%)",
     main = "Wilshire 5000")
lines(WW$rr_distr$x, WW$rr_distr$y_norm1, col = "green2", lwd = 2)
lines(WW$rr_distr$x, WW$rr_distr$y_norm2, col = "blue2", lwd = 2)
lines(WW$rr_distr$x, WW$rr_distr$y_gl, col = "red2", lwd = 2)
# lines(xxlin, W5000r.y.n2, col = "blue2", lwd = 2)
# lines(xxlin, W5000r.y.gl, col = "red2", lwd = 2)
```

```{r wilshire5000-plot_distributions_v2, cache = TRUE, fig.width = 7.0, fig.height = 5.0}
# plot_return_distributions(data = W5000_data.df, fits = W5000_fits.df)
# plot_return_distributions(data = Wilsh5000r, fits = W5000_fits.df)
plot_return_distributions(data = WW$rr_rel, fits = WW$rr_distr)
```

#### ALT

Fit with Generalized Lambda Distribution:

```{r wilshire5000-fit_gld_rlog, cache = TRUE}
W5000rlog.fit <- fun.RMFMKL.ml(Wilsh5000rlog)
W5000rlog.y.gl <- dgl(xxlog, W5000rlog.fit)

nfit1 <- fitdistr(Wilsh5000rlog[abs(Wilsh5000rlog) <= 0.02], "normal")
W5000rlog.y.n1 <- dnorm(xxlog, mean = nfit1$estimate[1], sd = nfit1$estimate[2])
```

```{r wilshire5000-prepare_df_rlog}
# W5000_data.df <- data.frame(returns = Wilsh5000r, log_returns = Wilsh5000rlog, stringsAsFactors = FALSE)
W5000_fits_log.df <- data.frame(x = xxlog, ygl = W5000rlog.y.gl, yn = W5000rlog.y.n1)
plot(W5000_fits_log.df$x, W5000_fits_log.df$yn, xlim = c(-0.15, 0.15), type = "l")
plot(W5000_fits_log.df$x, W5000_fits_log.df$ygl, xlim = c(-0.15, 0.15), type = "l")
```

Plot distributions:

```{r wilshire5000-plot_distributions_rlog, cache = TRUE, eval = FALSE}
hist(Wilsh5000rlog, breaks = seq(-2.0, 2.0, by = 0.0025), xlim = c(-0.1, 0.1), freq = FALSE,
     xlab = "log of daily returns",
     main = "Wilshire 5000")
lines(xxlog, W5000rlog.y.n1, col = "blue2", lwd = 2)
lines(xxlog, W5000rlog.y.gl, col = "red2", lwd = 2)
# lines(W5000_fits_log.df$x, W5000_fits_log.df$ygl, col = "orange", lwd = 2)
```

```{r wilshire5000-plot_distributions_v2_ALT, cache = TRUE, fig.width = 7.0, fig.height = 5.0}
# plot_return_distributions(data = W5000_data.df, fits = W5000_fits_log.df, type = "lin", xlim = c(-8.0, 8.0), binwidth = 0.1)
plot_return_distributions_ALT(data = Wilsh5000rlog, fits = W5000_fits_log.df)
```

<hr class="thin_separator">

### S&P 500 

Fetch the data with `quantmod`:

```{r sp500-load, cache = TRUE}
getSymbols("^GSPC", from = start.date, to = end.date)
GSPC.vec <- as.vector(GSPC[, 4])
```

Prepare log-returns:

```{r sp500-returns, cache = TRUE}
SP500rlog <- diff(log(GSPC.vec), lag = 1)
SP500r <- 100.0*(exp(SP500rlog) - 1)
```

Fit with Generalized Lambda Distribution:

```{r sp500-fit_gld, cache = TRUE}
SP500r.fit <- fun.RMFMKL.ml(SP500r)
SP500r.y.gl <- dgl(xxlin, SP500r.fit)

SP500r.y.n <- dnorm(xxlin, mean = 0.0, sd = 0.7)
```

```{r sp500-prepare_df}
# SP500_data.df <- data.frame(returns = SP500, stringsAsFactors = FALSE)
SP500r_fits.df <- data.frame(x = xxlin, ygl = SP500r.y.gl, yn = SP500r.y.n)
```

Plot distributions:

```{r sp500-plot_distributions, cache = TRUE, eval = FALSE}
hist(SP500r, breaks = seq(-55.0, 55.0, by = 0.10), xlim = c(-8.0, 8.0), freq = FALSE,
     xlab = "daily returns (%)",
     main = "S&P 500")
lines(xxlin, SP500r.y.n, col = "blue2", lwd = 2)
lines(xxlin, SP500r.y.gl, col = "red2", lwd = 2)
```

```{r sp500-plot_distributions_v2, cache = TRUE, fig.width = 7.0, fig.height = 5.0}
plot_return_distributions(data = SP500r, fits = SP500r_fits.df)
```


<hr class="thin_separator">

### NASDAQ 100

Fetch the data with `quantmod`:

```{r nasdaq100-load, cache = TRUE}
getSymbols("^NDX", from = start.date, to = end.date)
NDX.vec <- as.vector(NDX[, 4])
```

Prepare log-returns:

```{r nasdaq100-returns, cache = TRUE}
N100rlog <- diff(log(NDX.vec), lag = 1)
N100r <- 100.0*(exp(N100rlog) - 1)
```

Fit with Generalized Lambda Distribution:

```{r nasdaq100-fit_gld, cache = TRUE}
N100r.fit <- fun.RMFMKL.ml(N100r)
N100r.y.gl <- dgl(xxlin, N100r.fit)

N100r.y.n <- dnorm(xxlin, mean = 0.0, sd = 1.1)
```

```{r nasdaq100-prepare_df}
# N100_data.df <- data.frame(returns = N100, stringsAsFactors = FALSE)
N100r_fits.df <- data.frame(x = xxlin, ygl = N100r.y.gl, yn = N100r.y.n)
```

Plot distributions:

```{r nasdaq100-plot_distributions, cache = TRUE, eval = FALSE}
hist(N100r, breaks = seq(-55.0, 55.0, by = 0.10), xlim = c(-8.0, 8.0), freq = FALSE,
     xlab = "daily returns (%)",
     main = "NASDAQ 100")
lines(xxlin, N100r.y.n, col = "blue2", lwd = 2)
lines(xxlin, N100r.y.gl, col = "red2", lwd = 2)
```

```{r nasdaq100-plot_distributions_v2, cache = TRUE, fig.width = 7.0, fig.height = 5.0}
plot_return_distributions(data = N100r, fits = N100r_fits.df)
```


## More Stuff (to clean)

```{r more_code, eval = FALSE}
ndays <- length(N100)/25
N <- 1e6

test.N100 <- rep(0, N)
for(j in 1:N) {
    dummy <- rgl(ndays, N100r.fit)
    test.N100[j] <- (cumprod(1 + dummy/100)[ndays] - 1.0)*100
}


test.SP500 <- rep(0, N)
for(j in 1:N) {
    dummy <- rgl(ndays, SP500r.fit)
    test.SP500[j] <- (cumprod(1 + dummy/100)[ndays] - 1.0)*100
}
```

```{r even_more_code, eval = FALSE}
# hist(test.N100, breaks = seq(-500.0, 500.0, by = 0.50), xlim = c(-200.0, 300.0), freq = FALSE, border = "red2")
# hist(test.SP500, breaks = seq(-500.0, 500.0, by = 0.50), xlim = c(-200.0, 300.0), freq = FALSE, border = "blue2", add = TRUE)

xx2 <- seq(-100, 200, by = 1.0)
yy.n100.n <- dnorm(xx2, mean = 16.08, sd = 36.13)
yy.sp500.n <- dnorm(xx2, mean = 9.57, sd = 21.97)
yy.n100.n <- dnorm(xx2, mean = mean(test.N100), sd = sd(test.N100))
yy.sp500.n <- dnorm(xx2, mean = mean(test.SP500), sd = sd(test.SP500))


png(file = "sp500_vs_n100_vs_gaussians.png", height = 1024, width = 1024, res = 144)

plot(density(test.SP500), xlim = c(-100.0, 200.0), type = "n", xlab = "annual return [%]", main = "S&P500 vs. NASDAQ100")
grid()
lines(density(test.N100), col = "red2", lwd = 3)
lines(density(test.SP500), col = "blue2", lwd = 3)
lines(xx2, yy.n100.n, col = "pink2", lty = 2, lwd = 3)
lines(xx2, yy.sp500.n, col = "lightblue", lty = 2, lwd = 3)

dev.off()
```


<hr class="separator">
<a name="APPENDIX"></a>

# APPENDIX

<a name="SessionInfo"></a>

## R Session Info

```{r R_session_info}
sessionInfo()
```
---
